---
title: "gibbonNetR: R Package for the Use of CNNs and Transfer Learning on Acoustic Data"
author: "Dena J. Clink and Abdul Hamid Ahmad"
date: "`r Sys.Date()`"
output: github_document
---

## Overview

This readme provides instructions and code for training and testing the performance of different convolutional neural network model architectures on spectrogram images. 


## Installation

You can install the `gibbonNetR` package from its repository using `devtools`:

```{r eval = FALSE}
# If you don't have devtools installed
install.packages("devtools")

# Install gibbonNetR
devtools::install_github("https://github.com/DenaJGibbon/gibbonNetR")
```


```{r, message=FALSE, echo=FALSE}
devtools::load_all("/Users/denaclink/Desktop/RStudioProjects/gibbonNetR")

# Load other required libraries
library(dplyr)
library(torch)
library(torchvision)
library(purrr)
```

## Download example training files on Zenodo and convert to spectrogram images

``` {r eval = FALSE}
library(gibbonNetR)

# Link to training clips on Zenodo
ZenodoLink <- 'https://zenodo.org/records/10927637/files/TrainingClipsMulti.zip?download=1'

# Download into specified zip file location
download.file(url = ZenodoLink, destfile = 'data/data.zip')

# Unzip folder
exdir <- 'data/trainingclips/'
utils::unzip(zipfile = 'data/data.zip', exdir = exdir )

# Check folder composition
TrainingDatapath <- paste(exdir,"TrainingClipsMulti",sep='')

# Check folder names
list.files(TrainingDatapath)

# Create spectrogram images
gibbonNetR::spectrogram_images(
  trainingBasePath = TrainingDatapath,
  outputBasePath   = 'data/examples/',
  splits           = c(0.7, 0.3, 0),  # 70% training, 30% validation
  minfreq.khz = 0.4,
  maxfreq.khz = 2,
  new.sampleratehz= 'NA'
)

```

## Download example test files from Zenodo and convert to spectrogram images

``` {r eval = FALSE}
# Link to test clips on Zenodo
ZenodoLink <- 'https://zenodo.org/records/10927637/files/TestFilesMulti.zip?download=1'

# Download into specified zip file location
download.file(url = ZenodoLink, destfile = 'data/data.zip')

# Unzip folder
exdir <- 'data/testclips/'
utils::unzip(zipfile = 'data/data.zip', exdir = exdir )

# Check folder composition
TestDatapath <- paste(exdir,"TestFilesMulti",sep='')

# Check folder names
list.files(TestDatapath)

# Create spectrogram images
gibbonNetR::spectrogram_images(
  trainingBasePath = TestDatapath,
  outputBasePath   = 'data/examples/',
  splits           = c(0, 0, 1),  # 100% in test folder
  minfreq.khz = 0.4,
  maxfreq.khz = 2,
  new.sampleratehz= 'NA'
)


```

## Here are a few spectrogram images

```{r, echo=FALSE, fig.cap='Figure 1. Spectrograms of training clips for CNNs'}
knitr::include_graphics("/Users/denaclink/Desktop/RStudioProjects/gibbonNetR/README_files/spectro.png")
```

## Training the models using gibbonNetR and evaluating on a test set

```{r,eval = FALSE}
# Location of spectrogram images for training
input.data.path <-  'data/examples/'

# Location of spectrogram images for testing
test.data.path <- 'data/examples/test/'

# User specified training data label for metadata
trainingfolder.short <- 'danummulticlassexample'

# We can specify the number of epochs to train here
epoch.iterations <- c(20)

# Function to train a multi-class CNN
gibbonNetR::train_CNN_multi(input.data.path=input.data.path,
                            architecture ='resnet50',
                            learning_rate = 0.001,
                            class_weights = c(0.3, 0.3, 0.2, 0.2, 0),
                            test.data=test.data.path,
                            unfreeze.param = TRUE,
                            epoch.iterations=epoch.iterations,
                            save.model= TRUE,
                            early.stop = "yes",
                            output.base.path = "model_output/",
                            trainingfolder=trainingfolder.short,
                            noise.category = "noise")

```


## Extracting Performance Data

```{r, warning=FALSE}
# Evaluate model performance
performancetables.dir <- "model_output/_danummulticlassexample_multi_unfrozen_TRUE_/performance_tables_multi"

PerformanceOutput <- gibbonNetR::get_best_performance(performancetables.dir=performancetables.dir,
                                                      class='female.gibbon',
                                                      model.type = "multi",Thresh.val=0)

PerformanceOutput$f1_plot
PerformanceOutput$best_f1$F1

# Evaluate model performance
performancetables.dir <- "model_output/_danummulticlassexample_multi_unfrozen_TRUE_/performance_tables_multi"

PerformanceOutput <- gibbonNetR::get_best_performance(performancetables.dir=performancetables.dir,
                                                      class='hornbill.helmeted',
                                                      model.type = "multi",Thresh.val=0)

PerformanceOutput$f1_plot
PerformanceOutput$best_f1$F1


```


## Extract embeddings
```{r}

ModelPath <- "model_output/_danummulticlassexample_multi_unfrozen_TRUE_/_danummulticlassexample_20_resnet50_model.pt"
result <- extract_embeddings(test_input="data/examples/test/",
                                      model_path=ModelPath,
                                     target_class = "female.gibbon")

result$EmbeddingsCombined
result$NMI
result$ConfusionMatrix
```


```{r, eval=F, echo=FALSE}
# Load data
data("TempBinWav")

dir.create(paste(tempdir(),'/BinaryDir/Wav/'),recursive = T)

# Write to temp directory
writeWave(TempBinWav,filename = paste(tempdir(),'/BinaryDir/Wav/','TempBinWav.wav'))

train_CNN_binary(
    input.data.path = "inst/extdata/binary/",
    test.data = "inst/extdata/binary/test/",
    architecture = "alexnet",  # Choose 'alexnet', 'vgg16', 'vgg19', 'resnet18', 'resnet50', or 'resnet152'
    unfreeze.param = TRUE,
    batch_size = 6,
    learning_rate = 0.001,
    epoch.iterations = 1,  # Or any other list of integer epochs
    early.stop = "yes",
    save.model= TRUE,
    output.base.path = paste(tempdir(),'/BinaryDir/',sep=''),
    trainingfolder = "test_binary"
  )

TempFileList <- list.files(paste(tempdir(),'/BinaryDir/',sep=''),full.names = T,recursive = T)

ModelPath <- TempFileList[which(str_detect(TempFileList,'.pt'))]


deploy_CNN_binary(
  clip_duration = 12,
  architecture='alexnet',
  output_folder = paste(tempdir(),'/BinaryDir/Results/Images/',sep=''),
  output_folder_selections = paste(tempdir(),'/BinaryDir/Results/Selections/',sep=''),
  output_folder_wav = paste(tempdir(),'/BinaryDir/Results/Wavs/',sep=''),
  detect_pattern=NA,
  top_model_path = ModelPath,
  path_to_files = paste(tempdir(),'/BinaryDir/Wav/'),
  downsample_rate = 'NA',
  threshold = 0.5,
  save_wav = F,
  positive.class = 'Gibbons',
  negative.class = 'Noise',
  max_freq_khz = 2
)


# Deploy multiclass model example -----------------------------------------
# Load data
data("TempBinWav")

dir.create(paste(tempdir(),'/MultiDir/Wav/'),recursive = T)

# Write to temp directory
writeWave(TempBinWav,filename = paste(tempdir(),'/MultiDir/Wav/','TempBinWav.wav'))

train_CNN_multi(
  input.data.path = "inst/extdata/multiclass/",
  test.data = "inst/extdata/multiclass/test/",
  architecture = "resnet18",  # Choose 'alexnet', 'vgg16', 'vgg19', 'resnet18', 'resnet50', or 'resnet152'
  unfreeze.param = TRUE,
  batch_size = 6,
  class_weights = rep( (1/5), 5),
  learning_rate = 0.001,
  epoch.iterations = 3,  # Or any other list of integer epochs
  early.stop = "yes",
  save.model= TRUE,
  output.base.path = paste(tempdir(),'/MultiDir/',sep=''),
  trainingfolder = "test_multi",
  noise.category = 'noise'
)

TempFileList <- list.files(paste(tempdir(),'/MultiDir/',sep=''),full.names = T,recursive = T)

ModelPath <- TempFileList[which(str_detect(TempFileList,'model.pt'))]


deploy_CNN_multi(
  clip_duration = 12,
  architecture='resnet18',
  output_folder = paste(tempdir(),'/MultiDir/Results/Images/',sep=''),
  output_folder_selections = paste(tempdir(),'/MultiDir/Results/Selections/',sep=''),
  output_folder_wav = paste(tempdir(),'/MultiDir/Results/Wavs/',sep=''),
  detect_pattern=NA,
  top_model_path = ModelPath,
  path_to_files = paste(tempdir(),'/MultiDir/Wav/'),
  downsample_rate = 'NA',
  save_wav = F,
  class_names = c('duet','hornbill.helmeted','hornbill.rhino','long.argus','noise'),
  noise_category = 'noise',
  single_class = FALSE,
  threshold = .25,
  max_freq_khz = 2
)

# Embeddings
# Train simple CNN model
 train_CNN_binary(
   input.data.path = "inst/extdata/binary/",
   test.data = "inst/extdata/binary/test/",
   architecture = "alexnet",  # Choose 'alexnet', 'vgg16', 'vgg19', 'resnet18', 'resnet50', or 'resnet152'
   unfreeze.param = TRUE,
   batch_size = 6,
   learning_rate = 0.001,
   epoch.iterations = 1,  # Or any other list of integer epochs
   early.stop = "yes",
   save.model= TRUE,
   output.base.path = paste(tempdir(),'/BinaryDir/',sep=''),
   trainingfolder = "test_binary"
 )

# Create list of files in temp directory
TempFileList <- list.files(paste(tempdir(),'/BinaryDir/',sep=''),full.names = T,recursive = T)

# Find model path
ModelPath <- TempFileList[which(str_detect(TempFileList,'model.pt'))]

# Specify model path
ImageFile <- "inst/extdata/multiclass/test/"

# Function to extract and plot embeddings
result <- extract_embeddings(test_input=ImageFile,
                              model_path =ModelPath,
   target_class = "duet"
 )

print(result)

```
