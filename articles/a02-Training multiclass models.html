<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>2. Multiclass models • gibbonNetR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="2. Multiclass models">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">gibbonNetR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/a01a-Overview.html">1a. Overview</a></li>
    <li><a class="dropdown-item" href="../articles/a01b-GettingStarted.html">1b. Getting Started</a></li>
    <li><a class="dropdown-item" href="../articles/a02-Training%20multiclass%20models.html">2. Multiclass models</a></li>
    <li><a class="dropdown-item" href="../articles/a03-Training%20binary%20models.html">3. Binary models</a></li>
    <li><a class="dropdown-item" href="../articles/a04-Automated%20detection.html">4. Automated detection</a></li>
    <li><a class="dropdown-item" href="../articles/a05-UnsupervisedClustering.html">5. Unsupervised clustering</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>2. Multiclass models</h1>
            
      

      <div class="d-none name"><code>a02-Training multiclass models.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="first-load-the-package">First load the package<a class="anchor" aria-label="anchor" href="#first-load-the-package"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://denajgibbon.github.io/gibbonNetR/">gibbonNetR</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="model-training">Model training<a class="anchor" aria-label="anchor" href="#model-training"></a>
</h2>
<p>We start with a multi-class model. We will use the spectrogram images
for training, test and validation that we created above. Note that for
“input.data.path” the train and valid folders need to be there. For the
test data, the path must contain the ‘test’ folder. You can specify
multiple model architectures and number of epochs for training.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Location of spectrogram images for training</span></span>
<span><span class="va">input.data.path</span> <span class="op">&lt;-</span>  <span class="st">'data/trainingimages/'</span></span>
<span></span>
<span><span class="co"># Location of spectrogram images for testing</span></span>
<span><span class="va">test.data.path</span> <span class="op">&lt;-</span> <span class="st">'data/testimages/test/'</span></span>
<span></span>
<span><span class="co"># User specified training data label for metadata</span></span>
<span><span class="va">trainingfolder.short</span> <span class="op">&lt;-</span> <span class="st">'danummulticlassexample'</span></span>
<span></span>
<span><span class="co"># Specify the architecture type</span></span>
<span><span class="va">architecture</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'alexnet'</span>,<span class="st">'resnet50'</span><span class="op">)</span> <span class="co"># Choose 'alexnet', 'vgg16', 'vgg19', 'resnet18', 'resnet50', or 'resnet152'</span></span>
<span></span>
<span><span class="co"># We can specify the number of epochs to train here</span></span>
<span><span class="va">epoch.iterations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Function to train a multi-class CNN</span></span>
<span><span class="fu">gibbonNetR</span><span class="fu">::</span><span class="fu"><a href="../reference/train_CNN_multi.html">train_CNN_multi</a></span><span class="op">(</span>input.data.path<span class="op">=</span><span class="va">input.data.path</span>,</span>
<span>                            architecture <span class="op">=</span><span class="va">architecture</span>,</span>
<span>                            learning_rate <span class="op">=</span> <span class="fl">0.001</span>,</span>
<span>                            class_weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.3</span>, <span class="fl">0.2</span>, <span class="fl">0.2</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>                            test.data<span class="op">=</span><span class="va">test.data.path</span>,</span>
<span>                            unfreeze.param <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                            epoch.iterations<span class="op">=</span><span class="va">epoch.iterations</span>,</span>
<span>                            save.model<span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                            early.stop <span class="op">=</span> <span class="st">"yes"</span>,</span>
<span>                            output.base.path <span class="op">=</span> <span class="st">"data/model_output/"</span>,</span>
<span>                            trainingfolder<span class="op">=</span><span class="va">trainingfolder.short</span>,</span>
<span>                            noise.category <span class="op">=</span> <span class="st">"noise"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="model-evaluation">Model evaluation<a class="anchor" aria-label="anchor" href="#model-evaluation"></a>
</h2>
<div class="section level3">
<h3 id="specify-for-the-female-gibbon-class">Specify for the ‘female.gibbon’ class<a class="anchor" aria-label="anchor" href="#specify-for-the-female-gibbon-class"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Evaluate model performance</span></span>
<span><span class="va">performancetables.dir</span> <span class="op">&lt;-</span> <span class="st">"data/model_output/_danummulticlassexample_multi_unfrozen_TRUE_/performance_tables_multi"</span></span>
<span></span>
<span><span class="va">PerformanceOutput</span> <span class="op">&lt;-</span> <span class="fu">gibbonNetR</span><span class="fu">::</span><span class="fu"><a href="../reference/get_best_performance.html">get_best_performance</a></span><span class="op">(</span>performancetables.dir<span class="op">=</span><span class="va">performancetables.dir</span>,</span>
<span>                                                      class<span class="op">=</span><span class="st">'female.gibbon'</span>,</span>
<span>                                                      model.type <span class="op">=</span> <span class="st">"multi"</span>,Thresh.val<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="examine-the-results">Examine the results<a class="anchor" aria-label="anchor" href="#examine-the-results"></a>
</h3>
<p>Note that we would not expect great performance since we only trained
for one epoch.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>PerformanceOutput<span class="sc">$</span>f1_plot</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>PerformanceOutput<span class="sc">$</span>best_f1<span class="sc">$</span>F1</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">0.4862252</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>PerformanceOutput<span class="sc">$</span>best_auc<span class="sc">$</span>AUC</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">0.2858019</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>PerformanceOutput<span class="sc">$</span>best_precision<span class="sc">$</span>Precision</span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>[<span class="dv">1</span>] <span class="fl">0.321817</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>PerformanceOutput<span class="sc">$</span>best_recall<span class="sc">$</span>Recall</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>[<span class="dv">1</span>] <span class="dv">1</span></span></code></pre></div>
<img src="multiclass_eval.png" align="center" width="50%" height="50%"><figcaption><p>“Output from ‘get_best_performance’ fuction”</p>
</figcaption>
</div>
</div>
<div class="section level2">
<h2 id="trained-model-evaluation">Trained model evaluation<a class="anchor" aria-label="anchor" href="#trained-model-evaluation"></a>
</h2>
<p>We can deploy the trained model over another test dataset to see how
well it performs. In this case, the test data is organized into folders
with corresponding labels that match those from the training data.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>Modify the script above to download the apppropriate test files</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>ZenodoLink <span class="ot">&lt;-</span> <span class="st">'https://zenodo.org/records/14213067/files/testclipsmaliau.zip?download=1'</span></span></code></pre></div>
<p>We want to create spectrogram images for this new test dataset. The
sample rate for the original files was higher (48 kHz) so we use the
downsample call in the function to make sure the spectrogram images are
the same resolution.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">TestDatapath</span> <span class="op">&lt;-</span> <span class="st">'data/testclipsmaliau'</span></span>
<span></span>
<span><span class="co"># Create spectorgram images</span></span>
<span><span class="fu"><a href="../reference/spectrogram_images.html">spectrogram_images</a></span><span class="op">(</span></span>
<span>   trainingBasePath <span class="op">=</span> <span class="va">TestDatapath</span>,</span>
<span>   outputBasePath <span class="op">=</span> <span class="st">'data/testimagesmaliau/'</span>,</span>
<span>   minfreq.khz <span class="op">=</span> <span class="fl">0.4</span>,</span>
<span>   maxfreq.khz <span class="op">=</span> <span class="fl">1.6</span>,</span>
<span>   splits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, <span class="co"># Assign proportion to training, validation, or test folders</span></span>
<span>   new.sampleratehz <span class="op">=</span> <span class="fl">16000</span></span>
<span> <span class="op">)</span></span></code></pre></div>
<p>The ‘evaluate_trainedmodel_performance_multi’ function will compare
the model performance of pretrained models on another test dataset.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trained_models_dir</span> <span class="op">&lt;-</span> <span class="st">'/Users/denaclink/Desktop/RStudioProjects/gibbonNetR/data/model_output/_danummulticlassexample_multi_unfrozen_TRUE_/'</span></span>
<span></span>
<span><span class="va">class_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dput.html" class="external-link">dput</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="st">'/Users/denaclink/Desktop/RStudioProjects/gibbonNetR/data/trainingimages/train/'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">image_data_dir</span> <span class="op">&lt;-</span> <span class="st">'data/testimagesmaliau/test/'</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="st">'/data/model_output_test/'</span>,recursive <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/evaluate_trainedmodel_performance_multi.html">evaluate_trainedmodel_performance_multi</a></span><span class="op">(</span>trained_models_dir<span class="op">=</span><span class="va">trained_models_dir</span>,</span>
<span>                                          class_names<span class="op">=</span><span class="va">class_names</span>,</span>
<span>                                          image_data_dir<span class="op">=</span><span class="va">image_data_dir</span>,</span>
<span>                                           output_dir<span class="op">=</span> <span class="st">'data/model_output_test/'</span>,</span>
<span>                                           noise.category <span class="op">=</span> <span class="st">"noise"</span><span class="op">)</span></span></code></pre></div>
<p>Now we can use the same function as above ‘get_best_performance’ to
investigate model performance.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Evaluate model performance</span></span>
<span><span class="va">performancetables.dir</span> <span class="op">&lt;-</span> <span class="st">"data/model_output_test/performance_tables_multi_trained/"</span></span>
<span></span>
<span><span class="va">PerformanceOutput</span> <span class="op">&lt;-</span> <span class="fu">gibbonNetR</span><span class="fu">::</span><span class="fu"><a href="../reference/get_best_performance.html">get_best_performance</a></span><span class="op">(</span>performancetables.dir<span class="op">=</span><span class="va">performancetables.dir</span>,</span>
<span>                                                      class<span class="op">=</span><span class="st">'female.gibbon'</span>,</span>
<span>                                                      model.type <span class="op">=</span> <span class="st">"multi"</span>,Thresh.val<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p>We see that there is a high F1 score across thresholds for the
‘female.gibbon’ class</p>
<img src="multiclass__maliau_eval.png" align="center" width="50%" height="50%"><figcaption><p>“Output from ‘get_best_performance’ fuction”</p>
</figcaption>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Dena J. Clink.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
